# syn\_block

åŸºäº eBPF/XDP çš„æµé‡è¿‡æ»¤å·¥å…·ï¼Œä¸“ä¸º frps æœåŠ¡å™¨è®¾è®¡ï¼Œç”¨äºç¼“è§£ SYN Flood æ”»å‡»å¹¶é˜²æ­¢å†…ç½‘ç©¿é€æœåŠ¡çš„ IP è¯¯å°ã€‚

## âš ï¸ è­¦å‘Š (Disclaimer)

â€‹**æœ¬ç¨‹åºç›®å‰å¤„äºå®éªŒé˜¶æ®µ**ï¼Œå¯èƒ½å­˜åœ¨ Bugã€‚è¯·åŠ¡å¿…å°å¿ƒä½¿ç”¨ï¼Œè°¨æ…ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

> æœ¬äººè¿™ä¸€å¹´éƒ½ä¼šå¾ˆå¿™

> æ‰€æœ‰ä»£ç å‡ä¸ºGPLï¼Œè¯·éµå¾ªè®¸å¯åè®®

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬ç¨‹åºæ—¨åœ¨è¿è¡Œäº frpsï¼ˆæœåŠ¡ç«¯ï¼‰æœºå™¨ä¸Šï¼Œé€šè¿‡ eBPF æŠ€æœ¯åœ¨ç½‘å¡é©±åŠ¨å±‚ï¼ˆXDPï¼‰æˆ–é€šç”¨å±‚ï¼ˆSKBï¼‰è¿‡æ»¤éƒ¨åˆ†æ¶æ„æ”»å‡»æµé‡ã€‚

### ğŸ¯ è®¾è®¡åˆè¡·ä¸èƒŒæ™¯

åœ¨ä½¿ç”¨é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å™¨ä½œä¸º frps èŠ‚ç‚¹è¿›è¡Œå†…ç½‘ç©¿é€å’Œ SSH è½¬å‘æ—¶ï¼Œç»å¸¸é¢ä¸´ä»¥ä¸‹ç—›ç‚¹ï¼š

1. â€‹**SSHD é™åˆ¶**ï¼šè¢«è½¬å‘çš„ç›®æ ‡æœºå™¨ï¼ˆå†…ç½‘æœºå™¨ï¼‰ä¸Šçš„ SSHD æœåŠ¡å¾€å¾€ä¸æ”¯æŒï¼ˆæˆ–æ— æ³•é…ç½®ï¼‰é€šè¿‡ Proxy Protocol è·å–çœŸå®å®¢æˆ·ç«¯ IPã€‚
2. â€‹**IP æ··æ·†**ï¼šåœ¨ frp éš§é“ä¸‹ï¼Œæ‰€æœ‰æµé‡çš„æº IP åœ¨ç›®æ ‡æœºå™¨çœ‹æ¥éƒ½æ˜¯ frpc èŠ‚ç‚¹çš„ IP
3. â€‹**è¯¯å°ç¦**ï¼šå½“ frps é­é‡å…¬ç½‘æ‰«ææˆ– SYN Flood æ”»å‡»å¹¶è½¬å‘ç»™å†…ç½‘æ—¶ï¼Œå†…ç½‘æœºå™¨çš„ SSHD ä¼šæ£€æµ‹åˆ°å¤§é‡æ¥è‡ª frpc çš„å¤±è´¥å°è¯•ï¼Œä»è€Œé€šè¿‡ Fail2Ban ç­‰æœºåˆ¶å°† frpc çš„ IP æ‹‰é»‘ï¼Œå¯¼è‡´æ­£å¸¸æœåŠ¡ä¸­æ–­ã€‚

â€‹**æœ¬ç¨‹åºçš„ä½œç”¨**ï¼šåœ¨ frps æœåŠ¡å™¨å…¥å£å¤„ç›´æ¥è¯†åˆ«å¹¶é˜»æ–­æ¶æ„æ”»å‡»æµé‡ï¼Œé¿å…è¿™äº›æµé‡è¿›å…¥ frp è½¬å‘é“¾è·¯ï¼Œä»è€Œä¿æŠ¤åç«¯ SSHD ä¸è§¦å‘å°ç¦æœºåˆ¶ã€‚

## ğŸš€ ç”¨æ³•è¯´æ˜ (Usage)

### è¿è¡Œå‚æ•°

```
cargo run --release -- \
  --iface <ç½‘å¡å> \
  --ports <ç«¯å£åˆ—è¡¨> \
  --window-secs <ç»Ÿè®¡çª—å£ç§’æ•°> \
  --threshold <é˜»æ–­é˜ˆå€¼> \
  --block-secs <é˜»æ–­æ—¶é•¿>

```

### å‚æ•°è¯¦è§£

|**å‚æ•°**|**è¯´æ˜**|**ç¤ºä¾‹**|
| ------| --------------------------------| ------|
|â€‹`--iface`|æŒ‡å®šç›‘å¬çš„ç½‘å¡æ¥å£åç§°|â€‹`eth0`|
|â€‹`--ports`|éœ€è¦ç›‘æ§çš„ç«¯å£åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰|â€‹`22,80,443`|
|â€‹`--window-secs`|æµé‡ç»Ÿè®¡çš„æ—¶é—´çª—å£ï¼ˆç§’ï¼‰|â€‹`5`|
|â€‹`--threshold`|è§¦å‘é˜»æ–­çš„è¿æ¥æ•°é˜ˆå€¼|â€‹`100`|
|â€‹`--block-secs`|é˜»æ–­ç”Ÿæ•ˆçš„æ—¶é•¿ï¼ˆç§’ï¼‰|â€‹`60`|

### æ—¥å¿—æ§åˆ¶

é€šè¿‡ç¯å¢ƒå˜é‡ `RUST_LOG` æ§åˆ¶æ—¥å¿—çº§åˆ«ï¼š

- å¯é€‰ç­‰çº§ï¼š`off`â€‹, `error`â€‹, `warn`â€‹, `info`â€‹, `debug`â€‹, `trace`

ç¤ºä¾‹ï¼š

```
RUST_LOG=info cargo run --release -- ...

```

é€€å‡ºç¨‹åºï¼šä½¿ç”¨ `Ctrl + C`ã€‚

## ğŸ§ª æµ‹è¯•ç¯å¢ƒ (Tested Environments)

æœ¬é¡¹ç›®å·²åœ¨ä»¥ä¸‹å†…æ ¸å’Œç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•ï¼š

- **Linux (VirtIO / XDP):**

  - â€‹`6.17.10-x64v3-xanmod1` (virtio-net XDP)
  - â€‹`6.12.48+deb13-amd64` (Tencent Cloud, virtio-net XDP)
- **Linux (VirtIO / SKB Mode):**

  - â€‹`6.12.57+deb13-amd64`â€‹ (Aliyun, virtio-net SKB\_MODE) - *æ³¨ï¼šè¯¥ç¯å¢ƒæ”»å‡»æµé‡æå¤š*
- **WSL (Windows Subsystem for Linux):**

  - â€‹`6.6.87.2-microsoft-standard-WSL`â€‹ (hv\_netvsc)
- **Physical Hardware (Proxmox VE):**

  - â€‹`6.17.2-2-pve`â€‹ with **ixgbe X540-AT2** (60Mbps æµé‡æµ‹è¯•ï¼Œç”¨äºæ£€æµ‹æ€§èƒ½ç“¶é¢ˆ)
  - â€‹`6.17.2-2-pve`â€‹ with **igb I350** (700Mbps æµé‡æµ‹è¯•ï¼Œç”¨äºæ£€æµ‹æ€§èƒ½ç“¶é¢ˆ)

## ğŸ› ï¸ æ„å»ºä¸å¼€å‘ (Build & Development)

### å‰ç½®è¦æ±‚ (Prerequisites)

1. â€‹**Rust Toolchain (Stable)** â€‹: `rustup toolchain install stable`
2. â€‹**Rust Toolchain (Nightly)** â€‹: `rustup toolchain install nightly --component rust-src`
3. â€‹**bpf-linker**â€‹: `cargo install bpf-linker`â€‹ (macOS ä¸Šéœ€åŠ  `--no-default-features`)
4.  **(Cross-compile)**  Target: `rustup target add ${ARCH}-unknown-linux-musl`
5.  **(Cross-compile)**  LLVM: e.g., `brew install llvm` (macOS)
6.  **(Cross-compile)**  C Toolchain: e.g., `brew install filosottile/musl-cross/musl-cross` (macOS)

### ç¼–è¯‘ä¸è¿è¡Œ (Build & Run)

ä½¿ç”¨æ ‡å‡† cargo å‘½ä»¤å³å¯ï¼Œæ„å»ºè„šæœ¬ä¼šè‡ªåŠ¨å¤„ç† eBPF ç¨‹åºï¼š

```
cargo build
cargo check
cargo build --release
cargo run --release

```

